version: '3.8'
services:
  prometheus:
    image: prom/prometheus:latest
    ports: ["${PROMETHEUS_PORT:-9090}:9090"]
    volumes: 
      - "./prometheus.yml:/etc/prometheus/prometheus.yml"
      - "prometheus_data:/prometheus"
    command: 
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
    restart: unless-stopped
    networks: [monitoring]

  grafana:
    image: grafana/grafana:latest
    ports: ["${GRAFANA_PORT:-3000}:3000"]
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - "grafana_data:/var/lib/grafana"
      - "./grafana/provisioning:/etc/grafana/provisioning"
      - "./grafana/dashboards:/var/lib/grafana/dashboards"
    depends_on: [prometheus]
    restart: unless-stopped
    networks: [monitoring]

  node-exporter:
    image: prom/node-exporter:latest
    ports: ["${NODE_EXPORTER_PORT:-9100}:9100"]
    restart: unless-stopped
    networks: [monitoring]

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    ports: ["${CADVISOR_PORT:-8080}:8080"]
    volumes: ["/:/rootfs:ro", "/var/run:/var/run:ro", "/sys:/sys:ro", "/var/lib/docker/:/var/lib/docker:ro"]
    restart: unless-stopped
    networks: [monitoring]

  blackbox-exporter:
    image: prom/blackbox-exporter:latest
    ports: ["${BLACKBOX_PORT:-9115}:9115"]
    volumes: ["./blackbox.yml:/etc/blackbox_exporter/config.yml"]
    restart: unless-stopped
    networks: [monitoring]

volumes:
  prometheus_data:
  grafana_data:

networks:
  monitoring:
    driver: bridge
